<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Campaign Briefs - Creative Automation</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        :root {
            --brand-primary: #4f46e5;
        }

        body {
            background-color: #f4f6fb;
            color: #1f2937;
        }

        .card-surface {
            border-radius: 1rem;
        }

        .status-badge {
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .empty-icon {
            font-size: 3rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
        <div class="container py-2">
            <a class="navbar-brand fw-semibold text-uppercase text-primary" href="/">
                Creative Pipeline App
            </a>
            <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-primary" href="/upload-brief.html">Upload Brief</a>
                <a class="btn btn-sm btn-primary" href="/">Home</a>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <header class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
            <div>
                <h1 class="h3 mb-1">Campaign Briefs</h1>
                <p class="text-secondary mb-0">Monitor recent uploads, statuses, and localized assets.</p>
            </div>
            <a class="btn btn-primary" href="/upload-brief.html">âž• New Campaign Brief</a>
        </header>

        <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>

        <section id="loadingIndicator" class="card card-surface shadow-sm border-0 p-5 text-center bg-white">
            <div class="d-flex flex-column align-items-center gap-3">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-secondary mb-0">Loading campaign briefs...</p>
            </div>
        </section>

        <section id="emptyState" class="card card-surface shadow-sm border-0 p-5 text-center bg-white d-none">
            <div class="empty-icon mb-3">ðŸ“‹</div>
            <h2 class="h4 mb-2 text-primary">No Campaign Briefs yet</h2>
            <p class="text-secondary mb-4">Create your first campaign brief to kick off the automation pipeline.</p>
            <a class="btn btn-outline-primary" href="/upload-brief.html">Create Campaign Brief</a>
        </section>

        <section id="briefsGrid" class="row g-4 d-none"></section>
    </main>

    <div class="modal fade" id="briefModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title h5" id="modalTitle">Campaign Brief Details</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>

    <script>
        let briefs = [];
        let briefModal;

        const statusStyles = {
            pending: 'badge bg-warning-subtle text-warning-emphasis status-badge',
            processing: 'badge bg-info-subtle text-info-emphasis status-badge',
            completed: 'badge bg-success-subtle text-success-emphasis status-badge',
            failed: 'badge bg-danger-subtle text-danger-emphasis status-badge'
        };

        const assetPlaceholderTokens = ['placeholder', 'pending', 'pending-generation'];
        const MAX_PRODUCT_IMAGES = 2;

        function hasAssetPath(path) {
            if (!path || typeof path !== 'string') {
                return false;
            }

            const normalized = path.trim().toLowerCase();
            if (!normalized) {
                return false;
            }

            return !assetPlaceholderTokens.some(token => normalized.includes(token));
        }

        async function getTemporaryLink(dropboxPath) {
            try {
                const response = await fetch(`/storage/temporary-link?path=${encodeURIComponent(dropboxPath)}`);
                if (!response.ok) {
                    console.error(`Failed to get temporary link for ${dropboxPath}`);
                    return null;
                }
                const data = await response.json();
                return data.link;
            } catch (error) {
                console.error(`Error fetching temporary link for ${dropboxPath}:`, error);
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const bootstrapGlobal = window.bootstrap;
            const modalElement = document.getElementById('briefModal');
            if (bootstrapGlobal && modalElement) {
                briefModal = new bootstrapGlobal.Modal(modalElement);
            }
            loadBriefs();
            setInterval(loadBriefs, 30000);
        });

        async function loadBriefs() {
            toggleVisibility('errorAlert', false);

            try {
                const response = await fetch('/briefs');
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                briefs = await response.json();

                toggleVisibility('loadingIndicator', false);

                if (briefs.length === 0) {
                    toggleVisibility('emptyState', true);
                    toggleVisibility('briefsGrid', false);
                } else {
                    toggleVisibility('emptyState', false);
                    toggleVisibility('briefsGrid', true);
                    renderBriefs();
                }
            } catch (error) {
                showError(`Error loading briefs: ${error.message}`);
            }
        }

        function renderBriefs() {
            const grid = document.getElementById('briefsGrid');
            grid.innerHTML = '';

            briefs.forEach(brief => {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 col-lg-4';

                const uploadDate = new Date(brief.uploaded_at).toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                col.innerHTML = `
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h3 class="h5 mb-1 text-primary">${brief.campaign_id}</h3>
                                    <p class="text-secondary small mb-0">${brief.target_region}</p>
                                </div>
                                <span class="${statusStyles[brief.status] || 'badge bg-secondary'}">${brief.status}</span>
                            </div>
                            <dl class="row g-2 small text-secondary mb-3 flex-grow-1">
                                <dt class="col-6">Products</dt>
                                <dd class="col-6 text-end mb-0">${brief.product_count}</dd>
                                <dt class="col-6">Locales</dt>
                                <dd class="col-6 text-end mb-0">${brief.locale_count}</dd>
                                <dt class="col-6">Audience</dt>
                                <dd class="col-6 text-end mb-0">${brief.target_audience}</dd>
                                <dt class="col-6">Uploaded</dt>
                                <dd class="col-6 text-end mb-0">${uploadDate}</dd>
                            </dl>
                            <button type="button" class="btn btn-outline-primary w-100 mt-auto" data-campaign="${brief.campaign_id}">View details</button>
                        </div>
                    </div>
                `;

                grid.appendChild(col);
            });

            grid.querySelectorAll('button[data-campaign]').forEach(button => {
                button.addEventListener('click', (event) => {
                    const campaignId = event.currentTarget.getAttribute('data-campaign');
                    showBriefDetail(campaignId);
                });
            });
        }

        async function showBriefDetail(campaignId) {
            try {
                const response = await fetch(`/briefs/${campaignId}`);
                if (!response.ok) {
                    throw new Error(`Unable to load campaign ${campaignId}`);
                }

                const brief = await response.json();

                const productImageEntries = brief.products
                    .map(product => ({
                        id: product.id,
                        name: product.name,
                        path: product.image_path
                    }))
                    .filter(item => hasAssetPath(item.path))
                    .slice(0, MAX_PRODUCT_IMAGES);

                // Fetch temporary links for all product images
                const productImagesWithLinks = await Promise.all(
                    productImageEntries.map(async (entry) => {
                        const tempLink = await getTemporaryLink(entry.path);
                        return { ...entry, tempLink };
                    })
                );

                const productImagesMarkup = productImagesWithLinks
                    .filter(entry => entry.tempLink) // Only show images that have valid links
                    .map(({ id, name, tempLink }) => {
                        const label = name || id || 'Product';
                        const caption = name && id ? `${name} (${id})` : label;
                        return `
                            <figure class="mb-0 text-center">
                                <div class="ratio ratio-1x1 rounded border bg-white shadow-sm overflow-hidden" style="width: 140px;">
                                    <img src="${escapeHtml(tempLink)}" alt="${escapeHtml(label)} image" class="object-fit-cover w-100 h-100" loading="lazy">
                                </div>
                                <figcaption class="small text-secondary mt-2 text-truncate" title="${escapeHtml(caption)}">${escapeHtml(label)}</figcaption>
                            </figure>
                        `;
                    }).join('');

                const productImagesSection = productImageEntries.length ? `
                    <section class="mb-4">
                        <h3 class="h6 text-uppercase text-secondary fw-semibold">Product Images</h3>
                        <div class="d-flex flex-wrap gap-3">
                            ${productImagesMarkup}
                        </div>
                    </section>
                ` : '';

                const logoPath = brief.brand && brief.brand.logo_path;
                const hasLogoImage = hasAssetPath(logoPath);

                // Fetch temporary link for logo if it exists
                const logoTempLink = hasLogoImage ? await getTemporaryLink(logoPath) : null;

                // Only show logo section if there's a valid logo image
                const brandLogoMarkup = logoTempLink
                    ? `
                        <div class="ms-auto d-flex flex-column align-items-start">
                            <div class="small text-secondary">Logo</div>
                            <img src="${escapeHtml(logoTempLink)}" alt="Brand logo" class="rounded border bg-white shadow-sm" style="max-height: 64px; width: auto;" loading="lazy">
                        </div>
                    `
                    : '';

                document.getElementById('modalTitle').textContent = `Campaign: ${brief.campaign}`;

                const localizedMessages = brief.locales.map(locale => `
                    <div class="mb-3">
                        <h4 class="h6 text-primary mb-2">${locale}</h4>
                        <p class="mb-1"><strong>Message:</strong> ${brief.message[locale]}</p>
                        <p class="mb-0"><strong>CTA:</strong> ${brief.cta[locale]}</p>
                    </div>
                `).join('');

                const productList = brief.products.map(product => `
                    <div class="border rounded-3 p-3 mb-3 bg-body-tertiary">
                        <div class="fw-semibold">${product.name} <span class="text-secondary">(${product.id})</span></div>
                        <div class="small text-secondary mt-2"><strong>Prompt:</strong> ${product.prompt}</div>
                        ${product.negative_prompt ? `<div class="small text-secondary mt-1"><strong>Negative:</strong> ${product.negative_prompt}</div>` : ''}
                        <div class="small text-muted mt-2"><strong>Image:</strong> ${product.image_path}</div>
                    </div>
                `).join('');

                const modalBody = `
                    <section class="mb-4">
                        <h3 class="h6 text-uppercase text-secondary fw-semibold">Campaign Details</h3>
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Region</dt><dd class="col-sm-8">${brief.target_region}</dd>
                            <dt class="col-sm-4">Audience</dt><dd class="col-sm-8">${brief.target_audience}</dd>
                            <dt class="col-sm-4">Template</dt><dd class="col-sm-8">${brief.template}</dd>
                            <dt class="col-sm-4">Aspect Ratios</dt><dd class="col-sm-8">${brief.aspect_ratios.join(', ')}</dd>
                            <dt class="col-sm-4">Locales</dt><dd class="col-sm-8">${brief.locales.join(', ')}</dd>
                        </dl>
                    </section>

                    <section class="mb-4">
                        <h3 class="h6 text-uppercase text-secondary fw-semibold">Brand Identity</h3>
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <div class="rounded-circle" style="width: 32px; height: 32px; background:${brief.brand.primary_hex}; border:1px solid rgba(15,23,42,0.1);"></div>
                            <div>
                                <div class="small text-secondary">Primary Hex</div>
                                <div class="fw-semibold">${brief.brand.primary_hex}</div>
                            </div>
                            ${brandLogoMarkup}
                        </div>
                    </section>

                    ${productImagesSection}

                    <section class="mb-4">
                        <h3 class="h6 text-uppercase text-secondary fw-semibold">Localized Messages</h3>
                        ${localizedMessages}
                    </section>

                    <section class="mb-4">
                        <h3 class="h6 text-uppercase text-secondary fw-semibold">Products (${brief.products.length})</h3>
                        ${productList}
                    </section>

                    <section>
                        <h3 class="h6 text-uppercase text-secondary fw-semibold">Raw JSON</h3>
                        <pre class="bg-body-tertiary rounded p-3 small">${escapeHtml(JSON.stringify(brief, null, 2))}</pre>
                    </section>
                `;

                document.getElementById('modalBody').innerHTML = modalBody;
                if (briefModal) {
                    briefModal.show();
                } else {
                    const bootstrapGlobal = window.bootstrap;
                    if (bootstrapGlobal) {
                        const modalInstance = new bootstrapGlobal.Modal(document.getElementById('briefModal'));
                        modalInstance.show();
                    }
                }
            } catch (error) {
                showError(error.message || 'Unable to load brief details');
            }
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            toggleVisibility('errorAlert', true);
            toggleVisibility('loadingIndicator', false);
            toggleVisibility('briefsGrid', false);
            toggleVisibility('emptyState', false);
        }

        function toggleVisibility(elementId, shouldShow) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.classList.toggle('d-none', !shouldShow);
        }

        function escapeHtml(value) {
            return value.replace(/[&<>"']/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[char]);
        }
    </script>
</body>
</html>
